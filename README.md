<h1>Malware Analysis Lab (Zeus Banking Trojan) üïµÔ∏è</h1>


<h2>Description</h2>
The primary objective of this lab was to learn how to analyze malware (specifically the Zeus Banking Trojan) by setting up a self-hosted, controlled environment using REMnux and FLARE VM on VirtualBox. This involved configuring their network to communicate with each other while remaining isolated from the internet, allowing for the safe detonation and study of malware samples.
<br />


<h2>Apps, Languages, & Utilities Used</h2>

- <b>PowerShell (Scripting - Windows)</b>
- <b>Terminal (Command Line Interface - varies by OS)</b>
- <b>VirtualBox (Virtualization Software)</b>

<h2>Environments Used </h2>

- <b>Ubuntu (Linux Distribution for REMnux)</b> 
- <b>Windows 10 Pro (Desktop Operating System for FlareVM)</b>
- <b>REMnux (Linux Distribution for Malware Analysis)</b> 
- <b>FlareVM (Malware Analysis Environment on Windows 10 Pro)</b> 


<h2>Testing Tools </h2>

- <b>VirusTotal &nbsp; (Online service for analyzing files and URLs for viruses, worms, trojans, and other malware.) </b>
- <b>PeStudio &nbsp; (Tool for analyzing portable executable files.) </b>
- <b>Floss &nbsp; (Tool for extracting strings from malware binaries.) </b>
- <b>Capa &nbsp; (Tool for analyzing capabilities of programs.) </b>
- <b>Cutter &nbsp; (Reverse engineering tool for analyzing binaries.) </b>
- <b>iNetSim &nbsp; (Software suite for simulating common internet services in a lab environment.) </b>
- <b>Wireshark &nbsp; (Network protocol analyzer for capturing and analyzing network traffic.) </b>
- <b>Procmon &nbsp; (Windows monitoring tool for observing system calls and processes.) </b>
- <b>Yara &nbsp; (Tool for identifying and classifying malware based on patterns and rules.) </b>

<h2>Steps Taken</h2>


### *1. Install Oracle VM VirtualBox Manager*
Navigate to https://www.virtualbox.org/, download the compatible version, and install it with dependencies.

### *2. Install Windows 10*
Visit https://www.microsoft.com/en-ca/software-download/windows10, get "Create Windows 10 installation media", click "Download tool now", choose "Create installation media (USB flash drive, DVD, or ISO file) for another PC", then select "ISO file" and save it. In Oracle VM VirtualBox Manager, click "Add" to create a new VM, name it, choose the previously downloaded Windows 10 ISO, select 4096MB RAM, 1 CPU, 50GB virtual disk, and finish. Start the VM, follow the installation prompts, select "Custom: Install Windows only (advanced)", and let Windows 10 install. Once installation is complete, use the "Search" option on the taskbar and type "Change proxy settings" and click it. Turn "Automatically detect settings" to "Off".
Then make sure to:
- Disable Windows Updates (at least until installation is finished)
- Disable Tamper Protection and any Anti-Malware solution (e.g., Windows Defender), preferably via Group Policy.

### *3. Install FlareVM*
* Open a `PowerShell` prompt as administrator
* Download the installation script [`installer.ps1`](https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1) to your Desktop:
  * `(New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"$([Environment]::GetFolderPath("Desktop"))\install.ps1")`
* Unblock the installation script:
  * `Unblock-File .\install.ps1`
* Enable script execution:
  * `Set-ExecutionPolicy Unrestricted -Force`
    * If you receive an error saying the execution policy is overridden by a policy defined at a more specific scope, you may need to pass a scope in via `Set-ExecutionPolicy Unrestricted -Scope CurrentUser -Force`. To view execution policies for all scopes, execute `Get-ExecutionPolicy -List`
* Finally, execute the installer script as follow:
  * `.\install.ps1`
    * To pass your password as an argument: `.\install.ps1 -password <password>`
    * To use the CLI-only mode with minimal user interaction: `.\install.ps1 -password <password> -noWait -noGui`
    * To use the CLI-only mode with minimal user interaction and a custom config file: `.\install.ps1 -customConfig <config.xml> -password <password> -noWait -noGui`
* After installation it is recommended to switch to `host-only` networking mode and take a VM snapshot

### *4. Install REMnux*
Visit https://docs.remnux.org/install-distro/get-virtual-appliance, click "VirtualBox OVA" and then "Download". Once the download completes, head over to VirtualBox and hover over "File", and then click "Import Appliance". Navigate to the REMNUX .ova file and click "Next". Use the default Appliance settings and click "Finish".

### *4. Configure Host-only Adapter Network Mode*
Open VirtualBox and click "Tools", then click "Create". A new network has been created named "VirtualBox Host-Only Ethernet Adapter #2", click it and then change the "IPv4 Address:" to `10.0.0.1` and click "Apply". Then click the "DHCP Server" tab and enter `10.0.0.2` as the "Server Address:". Replace the "Lower Address Bound" with `10.0.0.3` and the "Upper Address Bound" to `10.0.0.254`, then click "Apply".

### *4. Configure REMnux*
* With REMnux open, navigate to "Activities" and select "Terminal".
* Navigate to inetsim directory:
  * `/etc/inetsim`
* Open the inetsim configuration file:
  * `sudo nano inetsim.conf`
* Use the keyboard down arrow to navigate to `#start_service dns` and remove the comment.
* Then find the `#service_bind_address` comment and remove it, replace `10.0.0.1` with `0.0.0.0`.
* Navigate down to the `#dns_default_ip` comment and remove it along with replacing `10.0.0.1` with `10.0.0.4`.
  * Using your keyboard, hit `CTRL + X` and then hit `Y`, and finally press "Enter" once more.
 
 ### *4. Configure FlareVM and REMnux Ethernet Adapter*
 Open VirtualBox and click on "FlareVM" , then click "Settings" and finally click "Network". Choose "Host-only Adapter" in the dropdown "Attached to:", then choose "VirtualBox Host-Only Ethernet Adapter #2" as the "Name:". Repeat the same steps for the REMnux virtual machine within VirtualBox. Once completed, the two machines should only be able to communicate with each other, but not the internet. Next, open the "FlareVM" machine and type in "Ethernet Settings" in the Windows search bar. Click "Change adapter options", right click "Ethernet" and choose "Properties". Double click "Internet Protocol Version 4 (TCP/IPv4)" and change the "Preferred DNS server address" to the REMnux server address which is `10.0.0.4`.
 * After configuration it is recommended to ping both machines to ensure they can successfully communicate with each other over the Host-only network.

<br>

<h1> The Zeus Banking Trojan </h1>
The Zeus (Zbot) Banking Trojan, first spotted in 2007, is primarily designed to steal sensitive financial information from infected systems. It became infamous for its ability to exfiltrate data and add machines to botnets. The malware's source code was leaked in 2011, leading to the creation of numerous variants. One of the most notable variants is Gameover Zeus, which was dismantled by the FBI in 2014.
<br></br>

### Malware Composition
Filename: invoice_2318362983713_823931342io.pdf.exe
<br>
<br>Hashes:</br>
* md5: EA039A854D20D7734C5ADD48F1A51C34
* sha1: 9615DCA4C0E46B8A39DE5428AF7DB060399230B2
* sha256: 69E966E730557FDE8FD84317CDEF1ECE00A8BB3470C0B58F3231E170168AF169
<br>

<h2> Basic Static Analysis </h2>
Virus Total

<img src="https://i.imgur.com/gvFkYQc.png" height="65%" width="65%" alt="VirusTotalOutput"/>
<img src="https://i.imgur.com/mxSXUJr.png" height="65%" width="65%" alt="VirusTotalOutput"/>
67/74 security vendors flagged as malicious.

### Strings
Tools Used: PeStudio, Floss.exe, Capa

<img src="https://i.imgur.com/PFY4vH6.png" height="65%" width="65%" alt="VirusTotalOutput"/>
<img src="https://i.imgur.com/jUWp1U2.png" height="65%" width="65%" alt="VirusTotalOutput"/>

corect.com

* ascii,57,section:.pdata,-,-,-,-,AsksmaceaglyBubuPulsKaifTeasMistPeelGhisPrimChaoLyreroeno
* ascii,15,section:.pdata,-,-,-,-,KERNEL32.MulDiv
* ascii,35,section:.pdata,-,-,-,-,BagsSpicDollBikeAzonPoopHamsPyasmap
* ascii,28,section:.pdata,-,-,-,-,KERNEL32.SetCurrentDirectory
* ascii,11,section:.pdata,-,-,-,-,BardHolyawe
* ascii,20,section:.pdata,-,-,-,-,SHLWAPI.SHFreeShared
* ascii,47,section:.pdata,-,-,-,-,BathEftsDawnvilepughThroCymakohloverMitefuzerat
* ascii,28,section:.pdata,-,-,-,-,SHLWAPI.PathMakeSystemFolder
* ascii,41,section:.pdata,-,-,-,-,BemaCadsPodsWavyCedeRadsbrioOustPerefenom
* ascii,21,section:.pdata,-,-,-,-,USER32.SetDlgItemText
* ascii,33,section:.pdata,-,-,-,-,BullbonyaweeWaitsnugTierDriblibye
* ascii,21,section:.pdata,-,-,-,-,KERNEL32.VirtualQuery
* ascii,14,section:.pdata,-,-,-,-,CameValeWauler
* ascii,15,section:.pdata,-,-,-,-,USER32.IsIconic
* ascii,35,section:.pdata,-,-,-,-,CedeSalsshulLimyThroliraValeDonabox
* ascii,18,section:.pdata,-,-,-,-,USER32.CreateCaret
* ascii,24,section:.pdata,-,-,-,-,CellrotoCrudUntohighCols
* ascii,19,section:.pdata,-,-,-,-,KERNEL32.CreateFile
* ascii,25,section:.pdata,-,-,-,-,DenyLubeDunssawsOresvarut
* ascii,26,section:.pdata,-,-,-,-,SHLWAPI.PathRemoveFileSpec
* ascii,40,section:.pdata,-,-,-,-,DragRoutflusCrowPeatmownNewsyaksSerfmare
* ascii,18,section:.pdata,-,-,-,-,USER32.DestroyIcon
* ascii,11,section:.pdata,-,-,-,-,Dumpcotsavo
* ascii,20,section:.pdata,-,-,-,-,USER32.SetDlgItemInt
* ascii,62,section:.pdata,-,-,-,-,DungBadebankBangGelthoboCocaBozotsksWheyVaryShoghoseNipsCadisi
* ascii,15,section:.pdata,-,-,-,-,USER32.EndPaint
* ascii,58,section:.pdata,-,-,-,-,ExitRollWoodGumsgamaSloerevsWussletssinkYearZitiryesHypout
* ascii,19,section:.pdata,-,-,-,-,USER32.GetClassInfo
* ascii,15,section:.pdata,-,-,-,-,FociTalcileador
* ascii,29,section:.pdata,-,-,-,-,KERNEL32.ConvertDefaultLocale
* ascii,10,section:.pdata,-,-,-,-,GeneAilshe
* ascii,22,section:.pdata,-,-,-,-,KERNEL32.FindFirstFile
* ascii,27,section:.pdata,-,-,-,-,GhisGoodHowlCoonCigscateged
* ascii,28,section:.pdata,-,-,-,-,KERNEL32.GetWindowsDirectory
* ascii,47,section:.pdata,-,-,-,-,GimpWadsdashHoraYardSeatDeanScanscowRantKeasfib
* ascii,20,section:.pdata,-,-,-,-,KERNEL32.LCMapString
* ascii,9,section:.pdata,-,-,-,-,Haesourfe
* ascii,21,section:.pdata,-,-,-,-,USER32.GetKeyNameText
* ascii,35,section:.pdata,-,-,-,-,HoggSoonLasstwaeNapeCeilBawlscopdub
* ascii,29,section:.pdata,-,-,-,-,KERNEL32.SystemTimeToFileTime
* ascii,13,section:.pdata,-,-,-,-,Icontellnoway
* ascii,24,section:.pdata,-,-,-,-,SHLWAPI.PathRemoveBlanks
* ascii,32,section:.pdata,-,-,-,-,ImidslatJokyCombdrubChefBilkSale
* ascii,21,section:.pdata,-,-,-,-,USER32.GetShellWindow
* ascii,56,section:.pdata,-,-,-,-,IzararfsFlamWostAirsconsMouefemelallPoretweeSacsOxidMinx
* ascii,24,section:.pdata,-,-,-,-,SHLWAPI.PathAddExtension
* ascii,39,section:.pdata,-,-,-,-,JabsNaveFateLariManyLeeksecshiesBawlwoo
* ascii,31,section:.pdata,-,-,-,-,KERNEL32.CreateIoCompletionPort
* ascii,24,section:.pdata,-,-,-,-,KatsDoreOmerBetsKoraKeef
* ascii,25,section:.pdata,-,-,-,-,KERNEL32.GetShortPathName
* ascii,12,section:.pdata,-,-,-,-,KineChamLows
* ascii,28,section:.pdata,-,-,-,-,KERNEL32.SetCurrentDirectory
* ascii,8,section:.pdata,-,-,-,-,LeerMiff
* ascii,29,section:.pdata,-,-,-,-,KERNEL32.LeaveCriticalSection
* ascii,43,section:.pdata,-,-,-,-,MaarSectFiscNextMattbamsErasnimstoeaBadshon
* ascii,19,section:.pdata,-,-,-,-,USER32.GetClassInfo
* ascii,31,section:.pdata,-,-,-,-,MarkMokeOsesShwaSkegpornlimemim
* ascii,23,section:.pdata,-,-,-,-,KERNEL32.GetStartupInfo
* ascii,50,section:.pdata,-,-,-,-,MeanOrrabirogirtWorkGawpSassPirnVinoLotaPledEidefe
* ascii,20,section:.pdata,-,-,-,-,SHLWAPI.SHLockShared
* ascii,22,section:.pdata,-,-,-,-,NextLoveOralwanySurfhm
* ascii,28,section:.pdata,-,-,-,-,KERNEL32.VerSetConditionMask
* ascii,47,section:.pdata,-,-,-,-,NisiBoyolineJiaoveryObiaowedblamHaetMaulweensky
* ascii,24,section:.pdata,-,-,-,-,SHLWAPI.PathCanonicalize
* ascii,32,section:.pdata,-,-,-,-,OastcabskamiKartDumbInksSomsMass
* ascii,28,section:.pdata,-,-,-,-,KERNEL32.SetCurrentDirectory
* ascii,19,section:.pdata,-,-,-,-,PeckQuinFillrillsaw
* ascii,26,section:.pdata,-,-,-,-,KERNEL32.GetThreadPriority
* ascii,21,section:.pdata,-,-,-,-,KERNEL32.FindNextFile
* ascii,48,section:.pdata,-,-,-,-,RemsSlaySoreAnoaaxalbuffusesemeuMapsyogaHangLoud
* ascii,22,section:.pdata,-,-,-,-,SHLWAPI.PathMakePretty
* ascii,23,section:.pdata,-,-,-,-,RidsFineZingMickMomsdue
* ascii,21,section:.pdata,-,-,-,-,USER32.GetMonitorInfo
* ascii,25,section:.pdata,-,-,-,-,SeminerdsoloseenYaginobox
* ascii,25,section:.pdata,-,-,-,-,SHLWAPI.PathIsLFNFileSpec
* ascii,34,section:.pdata,-,-,-,-,SiretomsbritGrewIckyNapaLumsBoaren
* ascii,24,section:.pdata,-,-,-,-,KERNEL32.OpenFileMapping
* ascii,60,section:.pdata,-,-,-,-,SlabKitsSlayseptPfftjiffSabsdeskOafsNowtMemsKirnKepiMiffDunt
* ascii,22,section:.pdata,-,-,-,-,KERNEL32.OpenSemaphore
* ascii,28,section:.pdata,-,-,-,-,SoldKartAgueiliaRushWauldhal
* ascii,17,section:.pdata,-,-,-,-,SHLWAPI.PathIsUNC
* ascii,50,section:.pdata,-,-,-,-,SuitplieGunsMaidBaitFeusJiaotodycolyAlbsLuneToyspe
* ascii,14,section:.pdata,-,-,-,-,USER32.GetProp
* ascii,32,section:.pdata,-,-,-,-,SungActaKopsMaarposyparefuzedeck
* ascii,23,section:.pdata,-,-,-,-,SHLWAPI.PathIsDirectory
* ascii,43,section:.pdata,-,-,-,-,ToeaTailecusGeesSoliCadeSpueEndsPlaykaphall
* ascii,22,section:.pdata,-,-,-,-,SHLWAPI.PathRemoveArgs
* ascii,22,section:.pdata,-,-,-,-,Vavsrubepodsjadebrooli
* ascii,19,section:.pdata,-,-,-,-,USER32.GetUpdateRgn
* ascii,15,section:.pdata,-,-,-,-,VeerCrawFlateel
* ascii,29,section:.pdata,-,-,-,-,SHLWAPI.PathParseIconLocation
* ascii,27,section:.pdata,-,-,-,-,WainMeekPinyWonkpooflaudsir
* ascii,28,section:.pdata,-,-,-,-,KERNEL32.GetWindowsDirectory
* ascii,32,section:.pdata,-,-,-,-,WhopTestrangrapsdebsTzarNipaYins
* ascii,19,section:.pdata,-,-,-,-,KERNEL32.DeleteFile
* ascii,8,section:.pdata,-,-,-,-,YeukMags
* ascii,21,section:.pdata,-,-,-,-,KERNEL32.GlobalHandle
* ascii,57,section:.pdata,-,-,-,-,ZetaBeduPirnhipsjailTingSrisTeleAposhuskNameHoerflagemuwo
* ascii,15,section:.pdata,-,-,-,-,USER32.LoadIcon

`<?xml version='1.0' encoding='UTF-8' standalone='yes'?>
<assembly xmlns='urn:schemas-microsoft-com:asm.v1' manifestVersion='1.0'>
 <trustInfo xmlns="urn:schemas-microsoft-com:asm.v3">
 <security>
 <requestedPrivileges>
 <requestedExecutionLevel level='asInvoker' uiAccess="false"/>
 </requestedPrivileges>
 </security>
 </trustInfo>
</assembly>`

### Interesting API Calls
* AllowSetForegroundWindow: Allows a specified process to set the foreground window even if the
process does not currently own the foreground windows focus.
* GetCapture
* GetWindowTextLength
* GetEnvironmentVariable
* GetEnvironmentVariable
* VkKeyScan: Translates a character to the corresponding virtual-key code.
* GetAsyncKeyState: Allows you to determine whether a particular key is currently pressed or
released.
* PathRenameExtension
* WriteFile
* FindNextFile
* GetCurrentThread
* WinExec: Legacy function used to launch an application or execute a command line. Available in
earlier versions of Windows.
* GlobalAddAtom: Adds a string to the atom table. Atom table are used for storing small pieces of
string-based data. Legacy mechanism.
* GetClipboardOwner
* GetClipboardData
* EnumClipboardFormats
* DdeQueryNextServer
* GetConsoleAliasExesLength: Retrieves executable files.
* SetCurrentDirectory

### Virtual Size vs Raw Size
<img src="https://i.imgur.com/2GDDaJP.png" height="65%" width="65%" alt="VirusTotalOutput"/>
The file appears to NOT be compressed.


### Libraries
* KERNEL32.dll
* SHLWAPl.dll
* USER32.dll

### File Header 
<img src="https://i.imgur.com/bbHkqPU.png" height="65%" width="65%" alt="VirusTotalOutput"/>

### Basic Capa Output
<img src="https://i.imgur.com/uYQ7DY2.png" height="65%" width="65%" alt="VirusTotalOutput"/>
It appears this Zeus variant uses VM / Sandbox Evasion techniques to avoid inspection by Malware Analysts.

### Defense Evasion
<img src="https://i.imgur.com/W5HdSYv.png" height="65%" width="65%" alt="VirusTotalOutput"/>
Tests to see how long the Windows machine has been running with the GetTickCount() function. 

* MITRE ATT&CK sub-technique 3 T1497.003

<h2> Basic Dynamic Analysis </h2>

### Host-based Indicators
Tools Used: Procmon, iNetSim, Wireshark

<img src="https://i.imgur.com/sJ9AevF.png" height="65%" width="65%" alt="VirusTotalOutput"/>

Under invoice parent process has two child processes, including a suspended `cmd.exe` with a child `conhost.exe`.


<img src="https://i.imgur.com/jSQZmEX.png" height="65%" width="65%" alt="VirusTotalOutput"/>


<img src="https://i.imgur.com/B5Mv5Db.png" height="65%" width="65%" alt="VirusTotalOutput"/>

Under `wininit.exe` -> `svchost.exe` -> `GoogleUpdate.exe` is dropped.

<img src="https://i.imgur.com/w48m5XJ.png" height="65%" width="65%" alt="VirusTotalOutput"/>

Creates a new registry value in the Google Update location. Likely meaning each time Chrome
updates, the malware will be executed.

<img src="https://i.imgur.com/vnV5XKz.png" height="65%" width="65%" alt="VirusTotalOutput"/>

Drops `msimg32.ddl` and `InstallFlashPlayer.exe` into `C:\Users\arnold\AppData\Local\Temp\InstallFlashPlayer.exe` .

### Network-based Indicators

<img src="https://i.imgur.com/bDA9cq5.png" height="65%" width="65%" alt="VirusTotalOutput"/>

Started `inetsim` to simulate DNS server and Wireshark for packet capture.

<img src="https://i.imgur.com/xoabUlV.png" height="65%" width="65%" alt="VirusTotalOutput"/>

Captured a suspicious HTTP request out to `fpdownload.macromedia.com`.

<img src="https://i.imgur.com/ciZUqHY.png" height="65%" width="65%" alt="VirusTotalOutput"/>

Performing `nslookup` on `fpdownload.macromedia.com` shows an IP address of `23.79.186.115`,
which is not flagged as malicious on VirusTotal.

### Detection Rules (YARA)

YARA rule used to detect the Zeus Banking Trojan Version 26-Nov-2013.

```
// import pe
rule Zeus {
 meta:
 author="Jared W."
 description="A detection rule against ZuesBankingVersion_26Nov2013"
 strings:
 $file_name="invoice_2318362983713_823931342io.pdf.exe" ascii
 // Suspected name of functions and DLL functionalities.

$function_name_KERNEL32="AsksmaceaglyBubuPulsKaifTeasMistPeelGhisPrimChaoLyr
eroeno" ascii
 $function_name_KERNERL32_CreateFileA="CellrotoCrudUntohighCols"
ascii
 $function_name_KERNEL32_FINDFIRSTFILEA="GeneAilshe" ascii
 // PE Magic Byte.
 $PE_magic_byte="MZ"
 // Hex String Function Name + DLL.
 $hex_string_SHLWAPI_PATHREMOVEFILESPECA= {44 65 6E 79 4C 75 62 65 44
75 6E 73 73 61 77 73 4F 72 65 73 76 61 72 75 74 00 53 48 4C 57 41 50 49}
 condition:
 // Use the pe library to create fine-grained rules for PE files.
 // pe.ispie
 $PE_magic_byte at 0 and $filename
 and $function_name_KERNEL32
 or $function_name_KERNERL32_CreateFileA
 or $function_name_KERNEL32_FINDFIRSTFILEA
 and $hex_string_SHLWAPI_PATHREMOVEFILESPECA
```

